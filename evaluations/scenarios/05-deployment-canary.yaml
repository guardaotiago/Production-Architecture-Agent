name: "Canary Deployment Strategy for Microservice"
description: >
  Deploying a microservice to production using a canary deployment strategy.
  Validates that the orchestrator generates the correct deployment runbook,
  rollback procedure, smoke test definitions, and records the chosen strategy
  in the SDLC state.  Exercises the deployment phase gate end-to-end.

phases_covered: [6]
project_type: "generic"

setup:
  - description: "Create a temporary project directory"
    command: "mktemp -d /tmp/eval-canary-XXXXXX"
  - description: "Initialise SDLC tracking"
    command: >
      python $ORCHESTRATOR_ROOT/scripts/init_sdlc.py
        --project-name "orders-service"
        --output-dir $WORK_DIR
  - description: "Simulate that prior phases are complete by marking gates passed"
    command: >
      python -c "
      import json, pathlib
      p = pathlib.Path('$WORK_DIR/.sdlc/state.json')
      s = json.loads(p.read_text())
      for phase in ['requirements', 'development', 'cicd', 'testing', 'uat']:
          s['phases'][phase]['status'] = 'completed'
          s['phases'][phase]['gate_passed'] = True
      s['current_phase'] = 'deployment'
      s['phases']['deployment']['status'] = 'in_progress'
      p.write_text(json.dumps(s, indent=2))
      "
  - description: "Create basic project files to simulate a real service"
    command: |
      mkdir -p $WORK_DIR/src $WORK_DIR/docs
      echo 'console.log("orders-service")' > $WORK_DIR/src/index.js
      echo '{"name": "orders-service", "version": "1.0.0"}' > $WORK_DIR/package.json

steps:
  - phase: "deployment"
    action: "Create the deployment runbook for canary strategy"
    command: |
      cat > $WORK_DIR/docs/deployment-runbook.md <<'EOF'
      # Deployment Runbook — Canary Strategy

      ## Pre-Deployment
      1. Verify all prior gates (requirements through UAT) are passed
      2. Confirm Docker image tagged and pushed to registry
      3. Notify on-call engineers in #deployments channel

      ## Canary Rollout Steps
      1. Deploy new version to 5% of traffic (canary pod)
      2. Monitor error rate, latency p99, and CPU for 10 minutes
      3. If metrics are healthy, increase to 25% traffic
      4. Monitor for 15 minutes at 25%
      5. If still healthy, promote to 100% traffic
      6. Remove old version pods

      ## Post-Deployment
      1. Run smoke tests against production
      2. Verify dashboards show normal operation
      3. Update deployment log in SDLC state
      EOF
    expected: "docs/deployment-runbook.md created with canary rollout steps"

  - phase: "deployment"
    action: "Create the rollback procedure"
    command: |
      cat > $WORK_DIR/docs/rollback-procedure.md <<'EOF'
      # Rollback Procedure

      ## Automatic Rollback Triggers
      - Error rate exceeds 5% during canary window
      - p99 latency exceeds 2x baseline
      - Any health check failures on canary pod

      ## Manual Rollback Steps
      1. Scale canary deployment to 0 replicas
      2. Ensure 100% traffic routes to previous stable version
      3. Investigate root cause
      4. File incident report if rollback was triggered automatically
      EOF
    expected: "docs/rollback-procedure.md created"

  - phase: "deployment"
    action: "Define smoke tests for post-deployment verification"
    command: |
      cat > $WORK_DIR/tests/smoke-tests.sh <<'SMOKE'
      #!/usr/bin/env bash
      set -euo pipefail
      BASE_URL="${1:-http://localhost:3000}"
      echo "Running smoke tests against $BASE_URL..."
      curl -sf "$BASE_URL/health" | grep -q '"status":"ok"'
      echo "PASS: /health returns ok"
      curl -sf "$BASE_URL/orders" | grep -q '"orders"'
      echo "PASS: /orders returns order list"
      echo "All smoke tests passed."
      SMOKE
      chmod +x $WORK_DIR/tests/smoke-tests.sh
    expected: "tests/smoke-tests.sh exists and is executable"

  - phase: "deployment"
    action: "Record deployment strategy and pre-deployment checklist in state"
    command: >
      python -c "
      import json, pathlib
      p = pathlib.Path('$WORK_DIR/.sdlc/state.json')
      s = json.loads(p.read_text())
      notes = s['phases']['deployment']['notes']
      notes.append('Deployment strategy: canary (5% -> 25% -> 100%)')
      notes.append('Pre-deployment checklist complete: image built, on-call notified, gates verified')
      p.write_text(json.dumps(s, indent=2))
      "
    expected: "Deployment state notes contain strategy and checklist keywords"

  - phase: "deployment"
    action: "Validate the deployment gate"
    command: "python $ORCHESTRATOR_ROOT/scripts/gate_validator.py --phase deployment --project-dir $WORK_DIR"
    expected: "Exit code 0 — all deployment gate criteria pass"

  - phase: "deployment"
    action: "Verify project health dashboard reflects deployment readiness"
    command: "python $ORCHESTRATOR_ROOT/scripts/project_health.py --project-dir $WORK_DIR"
    expected: "Dashboard shows deployment phase in_progress and prior phases completed"

assertions:
  - description: "Deployment runbook exists"
    type: "file_exists"
    target: "$WORK_DIR/docs/deployment-runbook.md"
    expected: true

  - description: "Rollback procedure exists"
    type: "file_exists"
    target: "$WORK_DIR/docs/rollback-procedure.md"
    expected: true

  - description: "Smoke test script exists"
    type: "file_exists"
    target: "$WORK_DIR/tests/smoke-tests.sh"
    expected: true

  - description: "Deployment gate passes"
    type: "exit_code"
    target: "python scripts/gate_validator.py --phase deployment --project-dir $WORK_DIR"
    expected: 0

  - description: "State records canary as the deployment strategy"
    type: "state_check"
    target: "$WORK_DIR/.sdlc/state.json"
    expected: "deployment notes contain 'canary'"

tags: ["deployment", "canary", "rollback", "smoke-tests", "microservice"]
